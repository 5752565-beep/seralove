<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²Œì„ ìˆ™ì œ ê´€ë¦¬ì í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif; }
    body { margin: 0; background: #f3f4f6; color: #111827; }
    .app { max-width: 560px; margin: 0 auto; padding: 16px 14px 28px; }
    header { margin-bottom: 12px; }
    .title { font-size: 20px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7280; margin-top: 4px; }
    .card { background: #ffffff; border-radius: 16px; padding: 12px 12px; box-shadow: 0 3px 10px rgba(15,23,42,0.08); margin-bottom: 10px; }
    .field { margin-bottom: 10px; }
    .field-label { font-size: 12px; color: #6b7280; margin-bottom: 4px; }
    .field-row { display: flex; gap: 6px; }
    input[type="date"], input[type="text"], input[type="time"], textarea {
      padding: 7px 8px;
      font-size: 13px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      width: 100%;
      resize: vertical;
    }
    textarea { min-height: 60px; }
    .btn {
      border: none;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-small {
      border: none;
      border-radius: 10px;
      padding: 5px 8px;
      font-size: 11px;
      cursor: pointer;
    }
    .btn-primary { background: #4f46e5; color: #fff; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-outline { background: #fff; color: #374151; border: 1px solid #d1d5db; }
    .btn-soft { background: #eef2ff; color: #4f46e5; }
    .btn-soft2 { background: #ecfdf5; color: #15803d; }
    .task-row, .post-row {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #f3f4f6;
    }
    .task-row:last-child, .post-row:last-child { border-bottom: none; }
    .task-text { flex: 1; font-size: 13px; }
    .task-actions { display:flex; gap:4px; }
    .empty-text {
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      padding: 10px 4px;
    }
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
    }
    footer {
      margin-top: 18px;
      font-size: 11px;
      text-align: center;
      color: #9ca3af;
    }

    .post-thumb {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      object-fit: cover;
      margin-right: 8px;
      background:#e5e7eb;
    }
    .post-main { flex: 1; }
    .post-text {
      font-size: 12px;
      color:#374151;
      max-height: 3.4em;
      overflow: hidden;
      white-space: pre-wrap;
    }
    .post-meta { font-size: 11px; color:#9ca3af; margin-top:2px; }
    .post-actions { display:flex; gap:4px; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">ê²Œì„ ìˆ™ì œ ê´€ë¦¬ì</div>
      <div class="subtitle">ë‚ ì§œë³„ ìˆ™ì œ + ê²Œì„ ì •ë³´ ê²Œì‹œíŒ ê´€ë¦¬</div>
    </header>

    <!-- ë‚ ì§œ ì„ íƒ -->
    <div class="card">
      <div class="field">
        <div class="field-label">ê´€ë¦¬ ë‚ ì§œ ì„ íƒ (11ì‹œ ê¸°ì¤€ ê²Œì„ ë‚ ì§œ)</div>
        <div class="field-row">
          <input type="date" id="dateInput" />
        </div>
        <div style="margin-top:4px; font-size:11px; color:#6b7280;" id="dateInfo"></div>
      </div>
    </div>

    <!-- ìˆ™ì œ ìŠ¬ë¡¯ ì¶”ê°€ -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span class="field-label" style="font-size:13px; color:#374151;">ìƒˆ ìˆ™ì œ ìŠ¬ë¡¯ ì¶”ê°€</span>
        <span class="badge">ìˆ™ì œ ì´ë¦„ + ìŠ¬ë¡¯ + ì‹œê°„</span>
      </div>

      <div class="field">
        <div class="field-label">ìˆ™ì œ ì´ë¦„</div>
        <input type="text" id="questNameInput" placeholder="ì˜ˆ: ì¼ì¼ ê³µí†µ / ì „ë©´ì „ë¹„ ë“±" />
      </div>

      <div class="field">
        <div class="field-label">ìŠ¬ë¡¯ ì´ë¦„</div>
        <input type="text" id="slotNameInput" placeholder="ì˜ˆ: 11ì‹œ ë¦¬ì…‹ / 11 ~ 15 ë“±" />
      </div>

      <div class="field">
        <div class="field-label">ì´ë²¤íŠ¸ ì‹œê°„</div>
        <div class="field-row">
          <input type="time" id="eventTimeInput" />
        </div>
      </div>

      <button class="btn btn-primary" id="addTaskBtn" style="width:100%; margin-top:4px;">ìŠ¬ë¡¯ ì¶”ê°€</button>
    </div>

    <!-- ê³ ì • ìˆ™ì œ ìë™ ì¶”ê°€ -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span class="field-label" style="font-size:13px; color:#374151;">ê³ ì • ìˆ™ì œ ìë™ ì¶”ê°€</span>
        <span class="badge">ì¼ì¼ ê³µí†µ + ì „ë©´ì „ë¹„ + ìš”ì¼</span>
      </div>
      <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
        í˜„ì¬ ì„ íƒëœ ë‚ ì§œ(11ì‹œ ê¸°ì¤€ ê²Œì„ ë‚ ì§œ)ì— ê³ ì • ìˆ™ì œë¥¼ í•œ ë²ˆì— ì¶”ê°€í•©ë‹ˆë‹¤.<br>
        ì´ë¯¸ ìˆëŠ” í•­ëª©(ìˆ™ì œ ì´ë¦„ + ìŠ¬ë¡¯ ë™ì¼)ì€ ì¤‘ë³µìœ¼ë¡œ ì¶”ê°€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
      <div style="display:flex; gap:6px; flex-wrap:wrap;">
        <button class="btn btn-soft" id="addFixedDailyBtn" style="flex:1;">ì¼ì¼ ê³µí†µë§Œ ì¶”ê°€</button>
        <button class="btn btn-soft2" id="addFixedBattleBtn" style="flex:1;">ì „ë©´ì „ë¹„ë§Œ ì¶”ê°€</button>
      </div>
      <button class="btn btn-outline" id="addFixedAllBtn" style="width:100%; margin-top:6px;">ê³ ì • ìˆ™ì œ ì „ì²´ ì¶”ê°€</button>
      <button class="btn btn-soft" id="addWeekdayTasksBtn" style="width:100%; margin-top:8px;">
        ìš”ì¼ë³„ ê³ ì • ìˆ™ì œ ìë™ ì¶”ê°€
      </button>
    </div>

    <!-- ìˆ™ì œ ìŠ¬ë¡¯ ëª©ë¡ -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span class="field-label" style="font-size:13px; color:#374151;">í•´ë‹¹ ë‚ ì§œì˜ ìˆ™ì œ ìŠ¬ë¡¯ ëª©ë¡</span>
        <span style="display:flex; align-items:center; gap:6px;">
          <span class="badge" id="taskCountBadge">0ê°œ</span>
          <button class="btn-small btn-danger" id="deleteAllTasksBtn">ì „ì²´ ì‚­ì œ</button>
        </span>
      </div>
      <div id="taskList">
        <div class="empty-text">ë“±ë¡ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>

    <!-- ì²´í¬ ê¸°ë¡ ì´ˆê¸°í™” -->
    <div class="card">
      <div class="field-label" style="font-size:13px; color:#b91c1c; margin-bottom:6px;">ì²´í¬ ê¸°ë¡ ì´ˆê¸°í™”</div>
      <div style="font-size:12px; color:#6b7280; margin-bottom:8px;">
        í˜„ì¬ ì„ íƒëœ ë‚ ì§œì˜ ì‚¬ìš©ì ì²´í¬ ê¸°ë¡ì„ ëª¨ë‘ ì§€ì›ë‹ˆë‹¤.<br>
        (ìˆ™ì œ ìŠ¬ë¡¯ ëª©ë¡ì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ì²´í¬ë§Œ ë¦¬ì…‹)
      </div>
      <button class="btn btn-danger" id="resetChecksBtn" style="width:100%;">í•´ë‹¹ ë‚ ì§œ ì²´í¬ ì „ì²´ ì´ˆê¸°í™”</button>
    </div>

    <!-- ê²Œì„ ì •ë³´ ê²Œì‹œíŒ (ì´ë¯¸ì§€+ì„¤ëª… ì—…ë¡œë“œ) -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span class="field-label" style="font-size:13px; color:#374151;">ê²Œì„ ì •ë³´ ê²Œì‹œíŒ</span>
        <span class="badge">ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œ</span>
      </div>

      <div class="field">
        <div class="field-label">ì´ë¯¸ì§€ (ì„ íƒ)</div>
        <input type="file" id="postImageInput" accept="image/*" />
        <div style="margin-top:4px; font-size:11px; color:#9ca3af;">
          ì´ë¯¸ì§€ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ ì˜¬ë ¤ë„ ë©ë‹ˆë‹¤.
        </div>
      </div>

      <div class="field">
        <div class="field-label">ì„¤ëª…</div>
        <textarea id="postTextInput" placeholder="ì˜ˆ: ì˜¤ëŠ˜ ì ê²€ ë³´ìƒ ëª©ë¡ / ì´ë²¤íŠ¸ ì•ˆë‚´ ë“±"></textarea>
      </div>

      <button class="btn btn-primary" id="postUploadBtn" style="width:100%; margin-top:4px;">ê²Œì‹œë¬¼ ì˜¬ë¦¬ê¸°</button>
    </div>

    <!-- ê²Œì‹œë¬¼ ëª©ë¡ -->
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
        <span class="field-label" style="font-size:13px; color:#374151;">ë“±ë¡ëœ ê²Œì‹œë¬¼</span>
        <span class="badge" id="postCountBadge">0ê°œ</span>
      </div>
      <div id="postList">
        <div class="empty-text">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>
    </div>

    <footer>
      ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ê¸°ë³¸ê°’: 1234 (ì½”ë“œì—ì„œ ë³€ê²½ ê°€ëŠ¥) / 11ì‹œ ì´í›„ ì ‘ì† ì‹œ ì „ë‚  ë°ì´í„° ìë™ ì‚­ì œ
    </footer>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    // ğŸ”¥ Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBXSZndtSEXXuft34RwcNWelwSWwegGCMo",
      authDomain: "sera-daily-quest.firebaseapp.com",
      databaseURL: "https://sera-daily-quest-default-rtdb.firebaseio.com",
      projectId: "sera-daily-quest",
      storageBucket: "sera-daily-quest.firebasestorage.app",
      messagingSenderId: "718148155264",
      appId: "1:718148155264:web:cb0a651fa38f918e6ab365"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const ADMIN_PASSWORD = "1234"; // í•„ìš”í•˜ë©´ ë³€ê²½

    // DOM ìš”ì†Œ
    const dateInput = document.getElementById("dateInput");
    const dateInfo = document.getElementById("dateInfo");
    const questNameInput = document.getElementById("questNameInput");
    const slotNameInput = document.getElementById("slotNameInput");
    const eventTimeInput = document.getElementById("eventTimeInput");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const taskListEl = document.getElementById("taskList");
    const taskCountBadge = document.getElementById("taskCountBadge");
    const resetChecksBtn = document.getElementById("resetChecksBtn");
    const deleteAllTasksBtn = document.getElementById("deleteAllTasksBtn");

    const addFixedDailyBtn = document.getElementById("addFixedDailyBtn");
    const addFixedBattleBtn = document.getElementById("addFixedBattleBtn");
    const addFixedAllBtn = document.getElementById("addFixedAllBtn");
    const addWeekdayTasksBtn = document.getElementById("addWeekdayTasksBtn");

    const postImageInput = document.getElementById("postImageInput");
    const postTextInput = document.getElementById("postTextInput");
    const postUploadBtn = document.getElementById("postUploadBtn");
    const postListEl = document.getElementById("postList");
    const postCountBadge = document.getElementById("postCountBadge");

    let currentDateKey = null;
    let tasks = {};
    let tasksRef = null;

    let boardPosts = {};
    const boardPostsRef = db.ref("boardPosts");

    // ===== ë‚ ì§œ/í‚¤ ìœ í‹¸ =====
    function pad(n) { return n.toString().padStart(2, "0"); }

    function dateToKey(date) {
      const y = date.getFullYear();
      const m = pad(date.getMonth() + 1);
      const d = pad(date.getDate());
      return `${y}-${m}-${d}`;
    }

    // 11ì‹œ ê¸°ì¤€ ê²Œì„ ë‚ ì§œ í‚¤
    function getResetBasedKeyNow() {
      const now = new Date(); // í•œêµ­ì—ì„œ ì“°ë©´ KST
      const hour = now.getHours(); // 0~23
      if (hour < 11) {
        now.setDate(now.getDate() - 1);
      }
      return dateToKey(now);
    }

    function getYesterdayKey() {
      const d = new Date();
      d.setDate(d.getDate() - 1);
      return dateToKey(d);
    }

    function keyToKoreanText(key) {
      const parts = key.split("-");
      if (parts.length !== 3) return key;
      const y = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10);
      const d = parseInt(parts[2], 10);
      const dt = new Date(y, m - 1, d);
      const dayNames = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "];
      const dow = dayNames[dt.getDay()];
      return `${y}ë…„ ${m}ì›” ${d}ì¼ (${dow})`;
    }

    function getDayOfKey(dateKey) {
      const parts = dateKey.split("-");
      const y = parseInt(parts[0], 10);
      const m = parseInt(parts[1], 10) - 1;
      const d = parseInt(parts[2], 10);
      const dt = new Date(y, m, d);
      return dt.getDay(); // 0=ì¼,1=ì›”,2=í™”,3=ìˆ˜,4=ëª©,5=ê¸ˆ,6=í† 
    }

    // ğŸ”¹ ê³ ì • ìˆ™ì œ ì •ì˜ (ë„¤ê°€ ì§€ì •í•œ ë²„ì „)
    const fixedDailyTasks = [
      { questName: "ì£¼í˜•ì´ í•˜íŠ¸ëˆ„ë¥´ê¸°", slotName: "20íšŒ", eventTime: "" },
      { questName: "11ì‹œ ë¦¬ì…‹",        slotName: "ì¼ì¼ ë³´ìƒ ë°›ê¸°", eventTime: "" },
      { questName: "ë‚œí­ ì¢€ë¹„",        slotName: "4íšŒì¡ê¸°", eventTime: "" },
      { questName: "í˜¼ëˆì˜ë•…",         slotName: "ì§‘ê²° ëª¨ì§‘5íšŒ", eventTime: "" },
      { questName: "í˜¼ëˆì˜ë•…1",        slotName: "ì§‘ê²° ì°¸ì—¬30íšŒ", eventTime: "" },
      { questName: "ê²½ê¸°ì¥",           slotName: "5íšŒí•˜ê¸°", eventTime: "" },
      { questName: "í™”ë¬¼ì°¨ë³´ë‚´ê¸°",     slotName: "4ëŒ€ë³´ë‚´ê¸°", eventTime: "" },
      { questName: "ë¦¬ì†ŒìŠ¤ì°¾ê¸°",       slotName: "5ê°œì°¾ê¸°", eventTime: "" },
      { questName: "í˜„ìƒê¸ˆí€˜ìŠ¤íŠ¸",     slotName: "", eventTime: "" },
      { questName: "ë ˆì´ë” ì™„ë£Œí•˜ê¸°",  slotName: "", eventTime: "" }
    ];

    const fixedBattleTasks = [
      { questName: "ì „ë©´ì „ë¹„(11 ~ 15)", slotName: "", eventTime: "11~15" },
      { questName: "ì „ë©´ì „ë¹„(15 ~ 19)", slotName: "", eventTime: "15~19" },
      { questName: "ì „ë©´ì „ë¹„(19 ~ 23)", slotName: "", eventTime: "19~23" },
      { questName: "ì „ë©´ì „ë¹„(23 ~ 03)", slotName: "", eventTime: "23~03" },
      { questName: "ì „ë©´ì „ë¹„(03 ~ 07)", slotName: "", eventTime: "03~07" },
      { questName: "ì „ë©´ì „ë¹„(07 ~ 11)", slotName: "", eventTime: "07~11" }
    ];

    // ìš”ì¼ë³„ ì¶”ê°€ìš©
    const sundayTasks = [
      { questName: "ì‹œë ¨ì¢€ë¹„", slotName: "", eventTime: "" }
    ];
    const tueThuSunTasks = [
      { questName: "ì˜ì›…ì „ì¥", slotName: "ì§„ì˜ë³„ ì „ì¥", eventTime: "" }
    ];

    function addFixedToDate(list) {
      if (!currentDateKey) {
        alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      const existing = Object.values(tasks || {});
      list.forEach(item => {
        const exists = existing.some(t =>
          (t.questName || "") === item.questName &&
          (t.slotName || "") === item.slotName
        );
        if (!exists) {
          const ref = db.ref(`days/${currentDateKey}/tasks`).push();
          ref.set({
            questName: item.questName,
            slotName: item.slotName,
            eventTime: item.eventTime,
            order: Date.now()
          });
        }
      });
    }

    function addWeekdayTasks() {
      if (!currentDateKey) {
        alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      const day = getDayOfKey(currentDateKey); // 0~6
      let addedSomething = false;

      // ì¼ìš”ì¼: ì‹œë ¨ì¢€ë¹„ + ì˜ì›…ì „ì¥(ì§„ì˜ë³„ ì „ì¥)
      if (day === 0) {
        addFixedToDate(sundayTasks);
        addFixedToDate(tueThuSunTasks);
        addedSomething = true;
      }

      // í™”(2), ëª©(4): ì˜ì›…ì „ì¥(ì§„ì˜ë³„ ì „ì¥)
      if (day === 2 || day === 4) {
        addFixedToDate(tueThuSunTasks);
        addedSomething = true;
      }

      if (addedSomething) {
        alert("ìš”ì¼ë³„ ê³ ì • ìˆ™ì œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤. (ì´ë¯¸ ìˆëŠ” í•­ëª©ì€ ê±´ë„ˆëœ€)");
      } else {
        alert("ì´ ë‚ ì§œëŠ” ìš”ì¼ë³„ ê³ ì • ìˆ™ì œ ëŒ€ìƒì´ ì•„ë‹™ë‹ˆë‹¤.");
      }
    }

    addFixedDailyBtn.addEventListener("click", () => {
      addFixedToDate(fixedDailyTasks);
      alert("ì¼ì¼ ê³ ì • ìˆ™ì œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
    });

    addFixedBattleBtn.addEventListener("click", () => {
      addFixedToDate(fixedBattleTasks);
      alert("ì „ë©´ì „ë¹„ ê³ ì • ìˆ™ì œë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
    });

    addFixedAllBtn.addEventListener("click", () => {
      addFixedToDate([...fixedDailyTasks, ...fixedBattleTasks]);
      alert("ê³ ì • ìˆ™ì œ ì „ì²´ë¥¼ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.");
    });

    addWeekdayTasksBtn.addEventListener("click", () => {
      addWeekdayTasks();
    });

    // ğŸ”¹ ìˆ™ì œ ìŠ¬ë¡¯ ë Œë”ë§
    function renderTasks() {
      const entries = Object.entries(tasks).sort((a,b)=>{
        const ao = a[1].order || 0;
        const bo = b[1].order || 0;
        return ao - bo;
      });

      taskListEl.innerHTML = "";
      taskCountBadge.textContent = `${entries.length}ê°œ`;

      if (entries.length === 0) {
        taskListEl.innerHTML = '<div class="empty-text">ë“±ë¡ëœ ìŠ¬ë¡¯ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      entries.forEach(([id, t]) => {
        const row = document.createElement("div");
        row.className = "task-row";

        const text = document.createElement("div");
        text.className = "task-text";
        const q = t.questName || "";
        const s = t.slotName || "";
        const time = t.eventTime || "";
        const label = s ? `${q} - ${s}` : q;
        text.textContent = `${label} (${time || "ì‹œê°„ ì—†ìŒ"})`;

        const actions = document.createElement("div");
        actions.className = "task-actions";

        // ìˆ˜ì • ë²„íŠ¼
        const editBtn = document.createElement("button");
        editBtn.className = "btn-small btn-outline";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => {
          const qCur = t.questName || "";
          const sCur = t.slotName || "";
          const timeCur = t.eventTime || "";

          const newQ = prompt("ìˆ™ì œ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”.", qCur);
          if (newQ === null) return;

          const newS = prompt("ìŠ¬ë¡¯ ì´ë¦„ì„ ìˆ˜ì •í•˜ì„¸ìš”.", sCur);
          if (newS === null) return;

          const newT = prompt("ì´ë²¤íŠ¸ ì‹œê°„ì„ ìˆ˜ì •í•˜ì„¸ìš”. (ì˜ˆ: 11:00 ë˜ëŠ” 11~15, ë¹ˆì¹¸ ê°€ëŠ¥)", timeCur);
          if (newT === null) return;

          const updated = {
            questName: newQ.trim() || qCur,
            slotName: newS.trim() || sCur,
            eventTime: newT.trim()
          };

          db.ref(`days/${currentDateKey}/tasks/${id}`).update(updated);
        });

        // ì‚­ì œ ë²„íŠ¼
        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-danger";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          if (confirm(`"${t.questName || ""} - ${t.slotName || ""}" ìŠ¬ë¡¯ì„ ì‚­ì œí• ê¹Œìš”?`)) {
            db.ref(`days/${currentDateKey}/tasks/${id}`).remove();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        row.appendChild(text);
        row.appendChild(actions);
        taskListEl.appendChild(row);
      });
    }

    function attachTasksListener() {
      if (!currentDateKey) return;
      if (tasksRef) tasksRef.off();

      tasksRef = db.ref(`days/${currentDateKey}/tasks`);
      tasksRef.on("value", (snap) => {
        tasks = snap.val() || {};
        renderTasks();
      });
    }

    // ìƒˆ ìŠ¬ë¡¯ ì¶”ê°€
    addTaskBtn.addEventListener("click", () => {
      if (!currentDateKey) {
        alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      const questName = questNameInput.value.trim();
      const slotName = slotNameInput.value.trim();
      const eventTime = eventTimeInput.value || "";

      if (!questName || !slotName) {
        alert("ìˆ™ì œ ì´ë¦„ê³¼ ìŠ¬ë¡¯ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        return;
      }

      const ref = db.ref(`days/${currentDateKey}/tasks`).push();
      ref.set({
        questName,
        slotName,
        eventTime,
        order: Date.now()
      });

      slotNameInput.value = "";
      eventTimeInput.value = "";
    });

    // ì²´í¬ ê¸°ë¡ ì´ˆê¸°í™” (ì²´í¬ë§Œ)
    resetChecksBtn.addEventListener("click", () => {
      if (!currentDateKey) {
        alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (confirm(`${keyToKoreanText(currentDateKey)}ì˜ ì²´í¬ ê¸°ë¡ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?`)) {
        db.ref(`days/${currentDateKey}/checks`).remove();
        alert("ì²´í¬ ê¸°ë¡ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.");
      }
    });

    // í•´ë‹¹ ë‚ ì§œì˜ ìˆ™ì œ ìŠ¬ë¡¯ ì „ì²´ ì‚­ì œ (tasks + checks)
    deleteAllTasksBtn.addEventListener("click", () => {
      if (!currentDateKey) {
        alert("ë¨¼ì € ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.");
        return;
      }
      if (!confirm(`${keyToKoreanText(currentDateKey)}ì˜ ëª¨ë“  ìˆ™ì œ ìŠ¬ë¡¯ì„ ì‚­ì œí• ê¹Œìš”?\n(í•´ë‹¹ ë‚ ì§œì˜ ì²´í¬ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) {
        return;
      }
      db.ref(`days/${currentDateKey}/tasks`).remove();
      db.ref(`days/${currentDateKey}/checks`).remove();
      alert("í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ìŠ¬ë¡¯ê³¼ ì²´í¬ ê¸°ë¡ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.");
    });

    function initDate() {
      const key = getResetBasedKeyNow(); // ğŸ”¥ 11ì‹œ ê¸°ì¤€ ê²Œì„ ë‚ ì§œ í‚¤
      currentDateKey = key;
      dateInput.value = key;
      dateInfo.textContent = `${keyToKoreanText(key)} ê´€ë¦¬ ì¤‘ (í‚¤: ${key})`;
      attachTasksListener();
    }

    dateInput.addEventListener("change", () => {
      const val = dateInput.value;
      if (!val) return;
      currentDateKey = val;
      dateInfo.textContent = `${keyToKoreanText(val)} ê´€ë¦¬ ì¤‘ (í‚¤: ${val})`;
      attachTasksListener();
    });

    // ğŸ”¹ ê²Œì‹œíŒ ë Œë”ë§ (ìˆ˜ì •+ì‚­ì œ)
    function renderPosts() {
      const entries = Object.entries(boardPosts).sort((a,b)=>{
        const ao = a[1].createdAt || 0;
        const bo = b[1].createdAt || 0;
        return bo - ao; // ìµœì‹ ìˆœ
      });

      postListEl.innerHTML = "";
      postCountBadge.textContent = `${entries.length}ê°œ`;

      if (entries.length === 0) {
        postListEl.innerHTML = '<div class="empty-text">ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      entries.forEach(([id, p]) => {
        const row = document.createElement("div");
        row.className = "post-row";

        if (p.imageUrl) {
          const img = document.createElement("img");
          img.className = "post-thumb";
          img.src = p.imageUrl;
          row.appendChild(img);
        } else {
          const placeholder = document.createElement("div");
          placeholder.className = "post-thumb";
          row.appendChild(placeholder);
        }

        const main = document.createElement("div");
        main.className = "post-main";

        const textDiv = document.createElement("div");
        textDiv.className = "post-text";
        textDiv.textContent = p.text || "";

        const metaDiv = document.createElement("div");
        metaDiv.className = "post-meta";
        const date = p.createdAt ? new Date(p.createdAt) : null;
        metaDiv.textContent = date ? `ë“±ë¡: ${date.toLocaleString("ko-KR")}` : "";

        main.appendChild(textDiv);
        main.appendChild(metaDiv);

        const actions = document.createElement("div");
        actions.className = "post-actions";

        // ê²Œì‹œë¬¼ ìˆ˜ì •(í…ìŠ¤íŠ¸)
        const editBtn = document.createElement("button");
        editBtn.className = "btn-small btn-outline";
        editBtn.textContent = "ìˆ˜ì •";
        editBtn.addEventListener("click", () => {
          const curText = p.text || "";
          const newText = prompt("ê²Œì‹œë¬¼ ë‚´ìš©ì„ ìˆ˜ì •í•˜ì„¸ìš”.", curText);
          if (newText === null) return;
          db.ref(`boardPosts/${id}`).update({
            text: newText.trim() || curText
          });
        });

        // ê²Œì‹œë¬¼ ì‚­ì œ
        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-danger";
        delBtn.textContent = "ì‚­ì œ";
        delBtn.addEventListener("click", () => {
          if (confirm("ì´ ê²Œì‹œë¬¼ì„ ì‚­ì œí• ê¹Œìš”? (ì´ë¯¸ì§€ íŒŒì¼ì€ Storageì— ë‚¨ì•„ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)")) {
            db.ref(`boardPosts/${id}`).remove();
          }
        });

        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        row.appendChild(main);
        row.appendChild(actions);
        postListEl.appendChild(row);
      });
    }

    // ê²Œì‹œë¬¼ ì—…ë¡œë“œ
    postUploadBtn.addEventListener("click", async () => {
      const file = postImageInput.files[0] || null;
      const text = postTextInput.value.trim();

      if (!file && !text) {
        alert("ì´ë¯¸ì§€ë‚˜ ì„¤ëª… ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
        return;
      }

      postUploadBtn.disabled = true;
      postUploadBtn.textContent = "ì—…ë¡œë“œ ì¤‘...";

      try {
        let imageUrl = null;

        if (file) {
          const id = Date.now();
          const storageRef = storage.ref().child(`board/${id}_${file.name}`);
          await storageRef.put(file);
          imageUrl = await storageRef.getDownloadURL();
        }

        const newRef = boardPostsRef.push();
        await newRef.set({
          text,
          imageUrl,
          createdAt: Date.now()
        });

        postTextInput.value = "";
        postImageInput.value = "";
        alert("ê²Œì‹œë¬¼ì„ ë“±ë¡í–ˆìŠµë‹ˆë‹¤.");
      } catch (e) {
        console.error(e);
        alert("ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        postUploadBtn.disabled = false;
        postUploadBtn.textContent = "ê²Œì‹œë¬¼ ì˜¬ë¦¬ê¸°";
      }
    });

    // ê²Œì‹œíŒ ë¦¬ìŠ¤ë„ˆ
    boardPostsRef.on("value", (snap) => {
      boardPosts = snap.val() || {};
      renderPosts();
    });

    // ì „ë‚  ë°ì´í„° ì‚­ì œ (11ì‹œ ì´í›„ì—ë§Œ)
    function cleanPreviousDayIfAfterReset() {
      const now = new Date();
      const hour = now.getHours();
      if (hour >= 11) {
        const yesterdayKey = getYesterdayKey();
        db.ref(`days/${yesterdayKey}`).remove()
          .then(() => {
            console.log(`ì–´ì œ ë°ì´í„°(${yesterdayKey}) ì‚­ì œ ì™„ë£Œ`);
          })
          .catch((err) => {
            console.error("ì „ë‚  ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
          });
      }
    }

    // ë¹„ë°€ë²ˆí˜¸
    function askPassword() {
      const input = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
      if (input === null) {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í•„ìš”í•©ë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ ì£¼ì„¸ìš”.");
        return false;
      }
      if (input === ADMIN_PASSWORD) return true;
      alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return false;
    }

    function init() {
      if (!askPassword()) return;
      cleanPreviousDayIfAfterReset(); // 11ì‹œ ì´í›„ë©´ ì „ë‚  days/* ì‚­ì œ
      initDate();
    }

    init();
  </script>
</body>
</html>
