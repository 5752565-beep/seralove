<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„¸ë¼ì˜ ê²Œì„ì •ë³´ - ì‚¬ìš©ì í˜ì´ì§€</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }
    body {
      margin: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
    }
    .layout {
      width: 100%;
      max-width: 980px;
      display: flex;
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 55%);
      box-shadow: 0 20px 40px rgba(15,23,42,0.7);
    }

    /* --- ì‚¬ì´ë“œë°” --- */
    .sidebar {
      width: 230px;
      padding: 18px 16px;
      border-right: 1px solid rgba(148,163,184,0.25);
      background: linear-gradient(180deg, #020617 0%, #0b1120 40%, #020617 100%);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      gap: 8px;
      word-break: keep-all;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .brand-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.2);
      color: #e5e7eb;
      word-break: keep-all;
      overflow-wrap: break-word;
      white-space: normal;
    }
    .brand-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }
    .side-section-title {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .nav-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .nav-item {
      border: none;
      width: 100%;
      text-align: left;
      padding: 9px 10px;
      border-radius: 10px;
      background: transparent;
      color: #cbd5f5;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: all 0.15s ease-out;
    }
    .nav-item:hover {
      background: rgba(15,23,42,0.9);
    }
    .nav-item.active {
      background: linear-gradient(90deg, #22c55e 0%, #16a34a 50%, #15803d 100%);
      color: #0b1120;
    }

    .nav-item .badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.6);
      color: #e5e7eb;
    }
    .nav-item.active .badge {
      background: rgba(15,23,42,0.9);
      color: #bbf7d0;
    }

    .side-footer {
      margin-top: auto;
      font-size: 11px;
      color: #6b7280;
    }
    .side-footer strong {
      color: #e5e7eb;
    }

    /* --- ë©”ì¸ --- */
    .content {
      flex: 1;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 8px;
    }
    #dateSelect {
      width: 130px;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.8);
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
    }
    .date-badge {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.5);
    }

    .summary-card {
      border-radius: 14px;
      padding: 10px 12px;
      background: radial-gradient(circle at top right, #22c55e33, #020617 60%);
      border: 1px solid rgba(148,163,184,0.5);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }
    .summary-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    .panel {
      border-radius: 14px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(30,64,175,0.7);
      padding: 10px 10px 12px;
    }

    /* --- ìˆ™ì œ í…Œì´ë¸” --- */
    .quest-table-wrapper {
      overflow-x: auto;
      margin-top: 4px;
    }
    table.quest-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      min-width: 320px;
    }
    table.quest-table thead {
      background: rgba(15,23,42,0.9);
    }
    table.quest-table th,
    table.quest-table td {
      padding: 7px 8px;
      border-bottom: 1px solid rgba(55,65,81,0.7);
      white-space: nowrap;
    }
    table.quest-table tbody tr.done {
      background: rgba(22,163,74,0.15);
    }

    /* ì²´í¬ë°•ìŠ¤ ì¤‘ì•™ì •ë ¬ */
    .checkbox-cell {
      text-align: center;
      vertical-align: middle;
    }
    .checkbox-cell input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin: 0 auto;
      display: block;
    }

    /* --- ê²Œì‹œíŒ --- */
    .board-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .board-item {
      display: flex;
      gap: 8px;
      padding: 8px;
      border-radius: 12px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(55,65,81,0.9);
    }
    .board-thumb {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      object-fit: cover;
      background: #1f2937;
      cursor: pointer;
    }

    .board-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .board-text {
      font-size: 12px;
      color: #e5e7eb;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .empty-text {
      font-size: 13px;
      text-align: center;
      color: #9ca3af;
      padding: 16px 4px;
    }

    /* ì´ë¯¸ì§€ ëª¨ë‹¬ */
    .image-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .image-modal-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(15,23,42,0.9);
    }
    .image-modal-img {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.8);
    }

    @media (max-width:720px){
      .layout{ flex-direction:column; }
      .sidebar{ width:100%; border-right:none; }
      .nav-list{ flex-direction:row; }
      .nav-item{ flex:1; justify-content:center; }
      .content{ padding:12px; }
    }
  </style>
</head>
<body>

<div class="app">
  <div class="layout">

    <!-- â–£ ì‚¬ì´ë“œë°” -->
    <aside class="sidebar">
      <div>
        <div class="brand-title">
          ì„¸ë¼ì˜ ê²Œì„ì •ë³´
          <span class="brand-pill">Sera Daily Quest</span>
        </div>
        <div class="brand-sub">ì£¼í˜•ì´ê°€ ë§Œë“  ìˆ™ì œ ì²´í¬ ë„ìš°ë¯¸</div>
      </div>

      <div>
        <div class="side-section-title">MENU</div>
        <div class="nav-list">
          <button class="nav-item active" id="tabQuestsBtn">
            ìˆ™ì œ ì²´í¬
            <span class="badge" id="navQuestBadge">0/0</span>
          </button>
          <button class="nav-item" id="tabGuideBtn">
            ê²Œì„ ê°€ì´ë“œ
            <span class="badge" id="navGuideBadge">0ê°œ</span>
          </button>
        </div>
      </div>

      <div class="side-footer">
        í˜„ì¬ ê²Œì„ ë‚ ì§œ: <strong id="sideDateText">-</strong><br>
        (11ì‹œ ì „ = ì „ë‚ , 11ì‹œ ì´í›„ = ì˜¤ëŠ˜)
      </div>
    </aside>

    <!-- â–£ ë©”ì¸ -->
    <main class="content">

      <div class="top-bar">
        <div>
          <div class="top-title" id="topTitle">ìˆ™ì œ ì²´í¬</div>
        </div>

        <div class="date-box" style="display:none;">
          <div class="date-main" id="todayText" style="display:none;">-</div>
          <div class="date-badge" id="dateKeyText" style="display:none;">-</div>
          <input type="date" id="dateSelect" style="display:none;">
        </div>
      </div>

      <div class="summary-card">
        <div>
          <div class="summary-main" id="summaryMain">ì™„ë£Œ 0 / ì „ì²´ 0</div>
          <div class="summary-sub" id="summarySub">ê´€ë¦¬ìê°€ ë“±ë¡í•œ ìˆ™ì œê°€ ë³´ì—¬ìš”</div>
        </div>
        <div class="summary-pill" id="summaryPill">ì˜¤ëŠ˜ ìˆ™ì œ ì‹œì‘!</div>
      </div>

      <!-- ìˆ™ì œ íŒ¨ë„ -->
      <section class="panel" id="questsPanel">
        <div class="panel-header">
          <div class="panel-title">ìˆ™ì œ ì²´í¬</div>
        </div>
        <div id="questContent">
          <div class="empty-text">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </section>

      <!-- ê°€ì´ë“œ íŒ¨ë„ -->
      <section class="panel" id="guidePanel" style="display:none;">
        <div class="panel-header">
          <div class="panel-title">ê²Œì„ ê°€ì´ë“œ</div>
        </div>
        <div id="guideContent">
          <div class="empty-text">ë“±ë¡ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ -->
<div id="imageModal" class="image-modal">
  <div class="image-modal-backdrop"></div>
  <img id="imageModalImg" class="image-modal-img" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€" />
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBXSZndtSEXXuft34RwcNWelwSWwegGCMo",
    authDomain: "sera-daily-quest.firebaseapp.com",
    databaseURL: "https://sera-daily-quest-default-rtdb.firebaseio.com",
    projectId: "sera-daily-quest",
  storageBucket: "sera-daily-quest.firebasestorage.app", // âœ… ì½˜ì†”ì— ì°íŒ ê±°ë‘ ë™ì¼í•˜ê²Œ
    messagingSenderId: "718148155264",
    appId: "1:718148155264:web:cb0a651fa38f918e6ab365"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function pad(n){ return n.toString().padStart(2,"0"); }
  function dateToKey(date){
    return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`;
  }
  function getResetBasedKeyNow(){
    const now = new Date();
    if(now.getHours() < 11){
      now.setDate(now.getDate()-1);
    }
    return dateToKey(now);
  }
  function keyToKoreanText(key){
    const p = key.split("-");
    const dt = new Date(p[0], p[1]-1, p[2]);
    const day = ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "][dt.getDay()];
    return `${p[0]}ë…„ ${p[1]}ì›” ${p[2]}ì¼ (${day})`;
  }

  let currentDateKey = null;
  let tasks = {};
  let checks = {};
  let boardPosts = {};
  let tasksRef = null;
  let checksRef = null;
  const boardPostsRef = db.ref("boardPosts");

  const todayText = document.getElementById("todayText");
  const dateKeyText = document.getElementById("dateKeyText");
  const sideDateText = document.getElementById("sideDateText");
  const dateSelect = document.getElementById("dateSelect");

  const navQuestBadge = document.getElementById("navQuestBadge");
  const navGuideBadge = document.getElementById("navGuideBadge");

  const summaryMain = document.getElementById("summaryMain");
  const summarySub = document.getElementById("summarySub");
  const summaryPill = document.getElementById("summaryPill");

  const questsPanel = document.getElementById("questsPanel");
  const guidePanel = document.getElementById("guidePanel");
  const tabQuestsBtn = document.getElementById("tabQuestsBtn");
  const tabGuideBtn = document.getElementById("tabGuideBtn");

  const questContent = document.getElementById("questContent");
  const guideContent = document.getElementById("guideContent");

  const imageModal = document.getElementById("imageModal");
  const imageModalImg = document.getElementById("imageModalImg");

  function setActiveTab(tab){
    if(tab==="quests"){
      tabQuestsBtn.classList.add("active");
      tabGuideBtn.classList.remove("active");
      questsPanel.style.display="";
      guidePanel.style.display="none";
    }else{
      tabGuideBtn.classList.add("active");
      tabQuestsBtn.classList.remove("active");
      guidePanel.style.display="";
      questsPanel.style.display="none";
    }
  }
  tabQuestsBtn.onclick = ()=> setActiveTab("quests");
  tabGuideBtn.onclick = ()=> setActiveTab("guide");

  function renderQuests(){
    const entries = Object.entries(tasks).sort((a,b)=>(a[1].order||0)-(b[1].order||0));
    if(entries.length === 0){
      questContent.innerHTML = `<div class="empty-text">ë“±ë¡ëœ ìˆ™ì œê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
      summaryMain.textContent = "ì™„ë£Œ 0 / ì „ì²´ 0";
      navQuestBadge.textContent = "0/0";
      return;
    }

    const total = entries.length;
    const done = Object.keys(checks||{}).length;

    summaryMain.textContent = `ì™„ë£Œ ${done} / ì „ì²´ ${total}`;
    navQuestBadge.textContent = `${done}/${total}`;

    if(done === total){
      summaryPill.textContent = "ì˜¤ëŠ˜ ìˆ™ì œ ì „ë¶€ ì™„ë£Œ ğŸ‰";
    } else if(done === 0){
      summaryPill.textContent = "ì˜¤ëŠ˜ ìˆ™ì œ ì‹œì‘!";
    } else {
      summaryPill.textContent = "ì¡°ê¸ˆë§Œ ë” í•˜ë©´ ë!";
    }

    let html = `
      <div class="quest-table-wrapper">
        <table class="quest-table">
          <thead>
            <tr>
                          <th style="text-align:center;">ì²´í¬</th>

              <th>#</th>
              <th>ìˆ™ì œ</th>
              <th>ìŠ¬ë¡¯</th>
            </tr>
          </thead>
          <tbody>
    `;
    entries.forEach(([id,t],i)=>{
      const q = t.questName || "ê¸°íƒ€";
      const s = t.slotName || "-";
      const checked = checks[id];
      const trClass = checked ? "done" : "";
      html += `
        <tr class="${trClass}" data-id="${id}">
          <td class="checkbox-cell">
            <input type="checkbox" class="quest-checkbox" ${checked?"checked":""} />
          </td>
          <td>${i+1}</td>
          <td>${q}</td>
          <td>${s}</td>
        </tr>
      `;
    });
    html += `</tbody></table></div>`;
    questContent.innerHTML = html;

    const rows = questContent.querySelectorAll("tr[data-id]");
    rows.forEach(row=>{
      const id = row.getAttribute("data-id");
      const cb = row.querySelector(".quest-checkbox");
      cb.addEventListener("change",()=>{
        const path = `days/${currentDateKey}/checks/${id}`;
        if(cb.checked) db.ref(path).set(true);
        else db.ref(path).remove();
      });
    });
  }

  function openImageModal(url){
    imageModalImg.src = url;
    imageModal.style.display = "flex";
  }
  function closeImageModal(){
    imageModal.style.display = "none";
    imageModalImg.src = "";
  }
  imageModal.addEventListener("click", closeImageModal);

  function renderBoard(){
    const entries = Object.entries(boardPosts).sort((a,b)=>(b[1].createdAt||0)-(a[1].createdAt||0));
    navGuideBadge.textContent = `${entries.length}ê°œ`;

    if(entries.length===0){
      guideContent.innerHTML = `<div class="empty-text">ë“±ë¡ëœ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    let html = `<div class="board-list">`;
    entries.forEach(([id,p])=>{
      const text = p.text || "";
      const img = p.imageUrl || "";
      html += `
        <div class="board-item">
          ${
            img
              ? `<img src="${img}" class="board-thumb zoomable" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">`
              : `<div class="board-thumb"></div>`
          }
          <div class="board-main">
            <div class="board-text">${text.replace(/\n/g,"<br>")}</div>
          </div>
        </div>
      `;
    });
    html += `</div>`;
    guideContent.innerHTML = html;

    // ì´ë¯¸ì§€ í™•ëŒ€ ì´ë²¤íŠ¸ ì—°ê²°
    const zoomables = guideContent.querySelectorAll(".zoomable");
    zoomables.forEach(imgEl=>{
      imgEl.addEventListener("click", ()=>{
        openImageModal(imgEl.src);
      });
    });
  }

  function attachListeners(){
    if(tasksRef) tasksRef.off();
    if(checksRef) checksRef.off();
    tasksRef = db.ref(`days/${currentDateKey}/tasks`);
    checksRef = db.ref(`days/${currentDateKey}/checks`);
    tasksRef.on("value",(snap)=>{
      tasks = snap.val()||{};
      renderQuests();
    });
    checksRef.on("value",(snap)=>{
      checks = snap.val()||{};
      renderQuests();
    });
  }

  function setDateKey(key){
    currentDateKey = key;
    todayText.textContent = keyToKoreanText(key);
    dateKeyText.textContent = `ê²Œì„ ë‚ ì§œ í‚¤: ${key}`;
    sideDateText.textContent = key;
    attachListeners();
  }

  function init(){
    const key = getResetBasedKeyNow();
    dateSelect.value = key;
    setDateKey(key);

    boardPostsRef.on("value",(snap)=>{
      boardPosts = snap.val()||{};
      renderBoard();
    });

    dateSelect.addEventListener("change",()=>{
      const k = dateSelect.value;
      if(k) setDateKey(k);
    });

    setActiveTab("quests");
  }

  init();
</script>

</body>
</html>
